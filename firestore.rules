
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // Items: Anyone can see them, only owners can manage them
    match /items/{itemId} {
      allow read;
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(resource.data.ownerId);
    }

    // Users: Profiles are public, but subcollections are private
    match /users/{userId} {
      allow read;
      allow create, update: if isOwner(userId);

      match /notifications/{notificationId} {
        allow read, list, write: if isOwner(userId);
      }
      
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isSignedIn();
      }
    }
    
    // Trades & Messages: Securely handle user conversations
    match /trades/{tradeId} {
      // Allow a user to create a trade if they are the proposer and a participant.
      allow create: if isSignedIn()
                    && request.resource.data.proposerId == request.auth.uid
                    && request.auth.uid in request.resource.data.participants
                    && request.resource.data.participants.size() == 2;
      
      // Allow read if a user is a participant.
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
      
      // Allow updates under specific, secure conditions.
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'updatedAt', 'proposerAgreedStart', 'receiverAgreedStart', 'proposerAgreedReturn', 'receiverAgreedReturn', 'reviewedByProposer', 'reviewedByReceiver', 'cancelledBy', 'cancelledAt']);

      // Rules for the messages subcollection within a trade
      match /messages/{messageId} {
        
        function parentTrade() {
          return get(/databases/$(database)/documents/trades/$(tradeId)).data;
        }

        // Participants may always READ their chat history
        allow read: if isSignedIn()
                    && request.auth.uid in parentTrade().participants;

        // Participants may SEND messages only while trade is active
        allow create: if isSignedIn()
                      && request.auth.uid in parentTrade().participants
                      && (parentTrade().status == "accepted" 
                          || parentTrade().status == "on-loan" 
                          || parentTrade().status == "return-pending");

        // Nobody should edit or delete messages
        allow update, delete: if false;
      }
    }


    // Hero Slides & Static Content
    match /hero_slides/{slideId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /reports/{reportId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false; // Only admins (via SDK) should read reports
    }
  }
}
